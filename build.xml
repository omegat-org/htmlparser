<project name="HTMLParser" default="htmlparser" basedir=".">

  <!-- set global properties for this build -->
  <property name="src" value="src"/>
  <property name="build" value="build"/>
  <property name="versionString" value="1_2"/>
  <property name="docs" value="docs"/>
  <property name="resources" value="resources"/>
  <property name="dist"  value="release/htmlparser${versionString}"/>
  <property name="releaseDir" value="release"/>
  <property name="finalLoc" value="distribution"/>
  <!-- location of junit.jar if there is no link to it in $JAVA_HOME/jre/lib/ext -->
  <property name="junit.jar" value="../nonexistant_directory/junit.jar"/>

  <target name="init" description="initialize version properties">
    <echo message="**********************************"/>
    <echo message="*  Initializing.....             *"/>
    <echo message="**********************************"/>
    <tstamp>
    	<format property="TODAY" pattern="yyyyMMdd" locale="en"/>
    	<format property="TODAY_STRING" pattern="MMM dd, yyyy"/>
    </tstamp>
    <property name="version" value="1_2_${TODAY}"/>
    <property name="displayVersion" value="&quot;1.2 (Integration Build ${TODAY_STRING})&quot;"/>
    <echo message="version=${version}"/>
    <echo message="displayVersion=${displayVersion}"/>

    <!-- set property VERSION_STRING to current display version -->
    <loadproperties srcFile="${src}/org/htmlparser/HTMLParser.java">
      <filterchain>
        <linecontains>
          <contains value="VERSION_STRING"/>
        </linecontains>
      </filterchain>
    </loadproperties>

    <property name="previousDisplayVersion" value="${VERSION_STRING}"/>
    <echo message="Detected Previous Display Version = ${previousDisplayVersion}"/>

    <!-- set property previousVersion to current version -->
    <loadfile srcFile="${src}/org/htmlparser/HTMLParser.java" property="previousVersion">
      <filterchain>
        <headfilter lines="1"/>
    	<filterreader classname="org.apache.tools.ant.filters.StripLineBreaks">
          <param name="linebreaks" value=" - A java-based parser for HTML"/>
        </filterreader>
    	<filterreader classname="org.apache.tools.ant.filters.StripLineBreaks">
    	  <param name="linebreaks" value="//Piy"/>
        </filterreader>
        <striplinebreaks/>
      </filterchain>      		
    </loadfile>
    <echo message="Detected Previous Version = ${previousVersion}"/>
	
  </target>

  <target name="versionSource" depends="init" description="update the version in all java files">
    <echo message="**********************************"/>
    <echo message="*  Incorporating version info    *"/>
    <echo message="**********************************"/>

    <echo message="Replacing version ${previousVersion} with ${version} in all source files"/>
	<replace dir="${src}" value="${version}">
	  <include name="**/*.java"/>
	  <replacefilter token="${previousVersion}"/>
	</replace>
  	<replace file="${src}/org/htmlparser/HTMLParser.java" token="${previousDisplayVersion}" value="${displayVersion}"/>
  	<replace file="${docs}/release.txt" token="${previousDisplayVersion}" value="${displayVersion}"/>  	
  </target>
  
  <target name="compile" description="compile all java files">
    <echo message="**********************************"/>
    <echo message="*  Compiling....                 *"/>
    <echo message="**********************************"/>

    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${build}"/>
    <!-- Compile the java code from ${src} into ${build} -->
    <javac srcdir="${src}" destdir="${build}" includes="org/htmlparser/**" excludes="org/htmlparser/tests/**,org/htmlparser/util/Generate.java" debug="on" />
  </target>

  <!-- Create the distribution of htmlparser.jar -->
  <target name="jar" depends="compile" description="create htmlparser.jar">
    <echo message="**********************************"/>
    <echo message="*  Creating htmlparser.jar....   *"/>
    <echo message="**********************************"/>

    <!-- Create the distribution directory -->
    <mkdir dir="${dist}/lib"/>

    <!-- Put everything in ${build} into the htmlparser.jar file -->
    <jar jarfile="${dist}/lib/htmlparser.jar" basedir="${build}" manifest="${resources}/Manifest.mf" />
  </target>

  <!-- Run the unit tests -->
  <target name="test" depends="jar" description="run the JUnit tests">
    <echo message="**********************************"/>
    <echo message="*  Running unit tests....        *"/>
    <echo message="**********************************"/>
    <javac srcdir="${src}" includes="org/htmlparser/tests/**" debug="on">
      <classpath>
        <pathelement location="${junit.jar}"/>
      </classpath>
    </javac>
    <java classname="org.htmlparser.tests.AllTests" fork="yes" failonerror="yes">
      <classpath>
        <pathelement location="${dist}/lib/htmlparser.jar"/>
        <pathelement location="${src}"/>
        <pathelement location="${junit.jar}"/>
      </classpath>
    </java>
  </target>

  <!-- Create the javadoc for the project -->
  <target name="javadoc" depends="init,CopyDoc" description="create JavaDoc (API) documentation">
    <echo message="**********************************"/>
    <echo message="*  Generating Javadoc....        *"/>
    <echo message="**********************************"/>

    <!-- Create the javadoc directory -->
    <mkdir dir="${dist}/docs/javadoc"/>

    <javadoc packagenames="org.htmlparser.*"
           sourcepath="${src}"
           defaultexcludes="yes"
           excludepackagenames="org.htmlparser.tests.*"
           destdir="${dist}/docs/javadoc"
           author="true"
           version="true"
           use="true"
           windowtitle="HTMLParser ${version}">
      <doctitle><![CDATA[<h1>HTMLParser ${version}</h1>]]></doctitle>
      <header><![CDATA[<A HREF="http://htmlparser.sourceforge.net" target="_top">HTML Parser Home Page</A>]]></header>
      <bottom><![CDATA[HTMLParser is an open source library released under LGPL. <BR> If you want to be notified when a new release of HTML Parser is out, join the <A HREF="http://lists.sourceforge.net/lists/listinfo/htmlparser-announce">HTMLParser Announcement List</A>.<BR>
If you have questions about the usage of the parser, join the <A HREF="http://lists.sourceforge.net/lists/listinfo/htmlparser-user">HTMLParser User List</A>. 
<BR>
If you want to join as a developer, please sign up on the <A HREF="http://lists.sourceforge.net/lists/listinfo/htmlparser-developer">HTMLParser Developer List</A>.<BR> All three lists can be joined from the <A HREF="http://htmlparser.sourceforge.net/mailinglists.html">HTMLParser Mailing Lists Page.</A>  ]]></bottom>
      <footer>(c) Dec 31, 2000 Somik Raha</footer>
      <group title="HTMLParser Main Package" packages="org.htmlparser"/>
      <group title="HTMLParser Tags" packages="org.htmlparser.tags"/>
      <group title="HTMLParser Scanners" packages="org.htmlparser.scanners"/>
      <group title="HTMLParser Utility Packages (of developer interest only)" packages="org.htmlparser.util"/>
    </javadoc>         
  </target>

  <!-- Copy the design documentation and release notes into the doc director -->
  <target name="CopyDoc" description="copy documentation to distribution directory">
    <echo message="**********************************"/>
    <echo message="*  Copying Documentation....     *"/>
    <echo message="**********************************"/>

    <copy todir="${dist}/docs">
    	<fileset dir="${docs}"/>
    </copy> 
    <!-- Copy the release notes as readme.txt in the base release directory -->
    <copy file="${docs}/release.txt" tofile="${dist}/readme.txt"/>

  </target>

  <!-- Copy the batch files into the htmlparser release directory -->
  <target name="CopyBatch" description="copy batch files to distribution directory">
    <echo message="**********************************"/>
    <echo message="*  Copying Batch Files....       *"/>
    <echo message="**********************************"/>

     <mkdir dir="${dist}/bin"/>   
     <copy todir="${dist}/bin" >
        <fileset dir="${resources}" includes="*.bat"/>
     </copy>
  </target>

  <!-- The release directory structuring finishes here -->  
  <target name="Release" depends="versionSource,jar,javadoc,CopyBatch" description="prepare the release files">
  </target>

  <!-- Package the release, creating the docs gzip also for uploading -->
  <target name="Package" depends="Release,sources" description="glom the release and source files into the distribution zip file">
    <echo message="**********************************"/>
    <echo message="*  Packaging....                 *"/>
    <echo message="**********************************"/>

    <mkdir dir="${finalLoc}"/>
    <zip zipfile="${finalLoc}/htmlparser${version}.zip"
       basedir="${releaseDir}"/>
    <tar tarfile="${finalLoc}/docs.tar" basedir="${dist}/docs"/>
    <gzip zipfile="${finalLoc}/docs.tar.gz" src="${finalLoc}/docs.tar"/>
  </target>
  
  <!-- Prepare the sources zip, allowing folks to build the code -->
  <target name="sources" description="create the source zip">
    <echo message="**********************************"/>
    <echo message="*  Preparing Sources....         *"/>
    <echo message="**********************************"/>

    <mkdir dir="${dist}/sources/src"/>
    <copy todir="${dist}/sources/src">
    	<fileset dir="${src}"/>
    </copy>
    <copy file="build.xml" todir="${dist}/sources"/>
	<mkdir dir="${dist}/sources/resources"/>
	<copy todir="${dist}/sources/resources" >
        <fileset dir="${resources}"/>
    </copy>
    <mkdir dir="${dist}/sources/docs"/>
    <copy todir="${dist}/sources/docs">
    	<fileset dir="${docs}"/>
    </copy>
    <zip zipfile="${dist}/src.zip"
       basedir="${dist}/sources"/>
    <delete dir="${dist}/sources"/>
  </target>

  <!-- Clean up -->
  <target name="htmlparser" depends="Package" description="vacuous, same as Package">
    <echo message="**********************************"/>
    <echo message="*  Cleaning up and finishing.... *"/>
    <echo message="**********************************"/>

    <!-- Delete the ${build} and ${dist} directory trees --> 
      <!--  <delete dir="${build}"/>-->
    <!-- Delete the release directory also -->
<!--    <delete dir="${releaseDir}"/> -->
  </target>
</project>
